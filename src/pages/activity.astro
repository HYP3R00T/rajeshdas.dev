---
import ActivityAccordion from "@/components/activity/ActivityAccordion.astro";
import WeeklySummaryCard from "@/components/activity/WeeklySummaryCard.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import githubEvents from "@github";
import projectData from "@project";
import type { GitHubEvent, ProjectsData } from "@/lib/types";
import {
  organizeEvents,
  groupEventsByTimePeriod,
  groupEventsByWeek,
} from "@/lib/github-activity";

// Type assertions for imports
const typedGithubEvents = githubEvents as GitHubEvent[];
const typedProjectData = projectData as ProjectsData;

// Organize events using the utility function
const { eventsByProject, regularEvents } = organizeEvents(
  typedGithubEvents,
  typedProjectData
);

// Group regular events by time period
const groupedEvents = groupEventsByTimePeriod(regularEvents);

// Group older events (lastMonth + earlier) by week for summary cards
const olderEvents = [...groupedEvents.lastMonth, ...groupedEvents.earlier];
const weeklySummaries = groupEventsByWeek(olderEvents);
---

<BaseLayout>
  <div class="flex w-full flex-col gap-8 px-6 md:max-w-4xl lg:max-w-6xl">
    <section class="w-full">
      <div class="col flex w-full flex-col gap-4">
        <h1 class="font-mono text-4xl">./activity --list</h1>

        <!-- Featured Projects Section -->
        {
          eventsByProject.length > 0 && (
            <div class="rounded-radius border-text-default/30 space-y-6 border-2 border-dashed p-6">
              <h2 class="text-cyan mb-4 text-2xl font-semibold">
                Featured Projects
              </h2>
              {eventsByProject.map(({ project, events, remainingEvents }) => {
                if (events.length === 0) return null;

                const totalCount = events.length + remainingEvents.length;

                return (
                  <div class="space-y-3">
                    <h3 class="text-text-default flex items-center gap-2 text-xl font-medium">
                      <a
                        href={`https://github.com/${project.id}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="hover:text-cyan transition-colors"
                      >
                        {project.title}
                      </a>
                      <span class="text-text-subtle text-sm">
                        (Latest {events.length} of {totalCount}{" "}
                        {totalCount === 1 ? "activity" : "activities"})
                      </span>
                    </h3>
                    <div class="pl-4">
                      {events.map((event) => (
                        <ActivityAccordion event={event} />
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          )
        }

        <!-- Regular Activity Section -->
        {
          regularEvents.length > 0 && (
            <div class="space-y-6">
              <h2 class="text-text-default mt-4 text-2xl font-semibold">
                All Activity
              </h2>

              {/* Last Week - Show individual activities */}
              {groupedEvents.lastWeek.length > 0 && (
                <div class="space-y-2">
                  <h3 class="text-cyan text-lg font-medium">Last Week</h3>
                  <div class="pl-4">
                    {groupedEvents.lastWeek.map((event) => (
                      <ActivityAccordion event={event} showProjectName={true} />
                    ))}
                  </div>
                </div>
              )}

              {/* Older Activities - Show as weekly summaries */}
              {weeklySummaries.length > 0 && (
                <div class="">
                  <h3 class="text-cyan text-lg font-medium">Previous Weeks</h3>
                  <div class="">
                    {weeklySummaries.map((summary) => (
                      <WeeklySummaryCard
                        weekStart={summary.weekStart}
                        weekEnd={summary.weekEnd}
                        events={summary.events}
                        projectCounts={summary.projectCounts}
                      />
                    ))}
                  </div>
                </div>
              )}
            </div>
          )
        }
      </div>
    </section>
    <div class="h-80"></div>
  </div>
</BaseLayout>

<script>
  document.addEventListener("astro:page-load", () => {
    document.querySelectorAll("[data-stop-propagation]").forEach((el) => {
      el.addEventListener("click", (e) => e.stopPropagation());
    });
  });
</script>
