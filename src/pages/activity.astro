---
import ActivityAccordion from "@/components/activity/ActivityAccordion.astro";
import WeeklySummaryCard from "@/components/activity/WeeklySummaryCard.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import githubEvents from "@data/github.json";
import projectData from "@data/project.json";
import type { GitHubEvent, ProjectsData } from "@/lib/types";
import {
  organizeEvents,
  groupEventsByTimePeriod,
  groupEventsByWeek,
} from "@/lib/github-activity";

const typedGithubEvents = githubEvents as GitHubEvent[];
const typedProjectData = projectData as ProjectsData;

const { eventsByProject, regularEvents } = organizeEvents(
  typedGithubEvents,
  typedProjectData
);

const groupedEvents = groupEventsByTimePeriod(regularEvents);
const olderEvents = [...groupedEvents.lastMonth, ...groupedEvents.earlier];
const weeklySummaries = groupEventsByWeek(olderEvents);
---

<BaseLayout>
  <section>
    <span>Proof I'm Actually Coding</span>
    <h1>GitHub Activity</h1>
    <p>
      Watch me push code, open issues, and occasionally merge PRs like a
      responsible adult. This is my green squares flexâ€”proof that I spend way
      too much time staring at my terminal. Spoiler: Most commits are "fix typo"
      and "actually fix typo this time."
    </p>
  </section>

  <section>
    {
      eventsByProject.length > 0 && (
        <div>
          <h2>Featured Projects</h2>
          {eventsByProject.map(({ project, events, remainingEvents }) => {
            if (events.length === 0) return null;
            const totalCount = events.length + remainingEvents.length;
            return (
              <article>
                <h3>
                  <a
                    href={`https://github.com/${project.id}`}
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    {project.title}
                  </a>
                  <span>
                    (Latest {events.length} of {totalCount}{" "}
                    {totalCount === 1 ? "activity" : "activities"})
                  </span>
                </h3>
                {events.map((event) => (
                  <ActivityAccordion event={event} />
                ))}
              </article>
            );
          })}
        </div>
      )
    }

    {
      regularEvents.length > 0 && (
        <div>
          <h2>All Activity</h2>
          {groupedEvents.lastWeek.length > 0 && (
            <article>
              <h3>Last Week</h3>
              {groupedEvents.lastWeek.map((event) => (
                <ActivityAccordion event={event} showProjectName={true} />
              ))}
            </article>
          )}
          {weeklySummaries.length > 0 && (
            <article>
              <h3>Previous Weeks</h3>
              {weeklySummaries.map((summary) => (
                <WeeklySummaryCard
                  weekStart={summary.weekStart}
                  weekEnd={summary.weekEnd}
                  events={summary.events}
                  projectCounts={summary.projectCounts}
                />
              ))}
            </article>
          )}
        </div>
      )
    }
  </section>
</BaseLayout>
