---
import BaseLayout from "@/layouts/BaseLayout.astro";
import type { PaginateFunction } from "astro";
import { getCollection } from "astro:content";
import type { PostsPageProps } from "@/lib/types";
import Pagination from "@/components/post/Pagination.astro";
import PostCard from "@/components/post/PostCard.astro";
import FeaturedPostCard from "@/components/post/FeaturedPostCard.astro";
import { SITE } from "@data/config";

export async function getStaticPaths({
  paginate,
}: {
  paginate: PaginateFunction;
}) {
  const posts = await getCollection("posts").then((entries) =>
    entries.filter((entry) => !entry.data.draft),
  );

  posts.sort((a, b) => {
    const aDate = new Date(a.data.pubDatetime).valueOf();
    const bDate = new Date(b.data.pubDatetime).valueOf();
    return bDate - aDate;
  });

  const featured = posts.find((p) => p.data.featured);
  const rest = featured ? posts.filter((p) => p.id !== featured.id) : posts;
  const pagination = paginate(rest, { pageSize: SITE.pageSize });

  return pagination.map((page) => ({
    ...page,
    props: {
      ...page.props,
      totalPages: pagination.length,
      featured,
      page: {
        ...page.props.page,
        pageSize: SITE.pageSize,
      },
    },
  }));
}

const { page, totalPages, featured } = Astro.props as PostsPageProps;
---

<BaseLayout>
  <section class="relative bg-black">
    <div class="mx-auto w-full max-w-7xl">
      <div class="">
        <!-- Badge -->
        <div
          class="border-foreground-0 bg-foreground-0 inline-block border px-3 py-1.5 font-mono text-xs font-medium tracking-wider text-black"
        >
          Blog
        </div>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 gap-12 lg:grid-cols-2 lg:gap-20">
          <!-- Left Column - Main Content -->
          <div>
            <!-- Main Heading -->
            <h1
              class="text-foreground-0 mb-8 text-left font-mono text-[clamp(3rem,10vw,7rem)] leading-[0.9] tracking-tighter uppercase"
            >
              <div>ARTICLES & INSIGHTS</div>
            </h1>

            <!-- Subtitle -->
            <div class="max-w-xl space-y-6">
              <p
                class="text-foreground-muted text-base leading-relaxed md:text-lg"
              >
                BThoughts and learnings on DevOps, infrastructure, automation,
                cloud architecture, and building reliable systems at scale.
              </p>
            </div>
          </div>
        </div>
      </div>
      <!-- Latest Article -->
      {
        featured && page.currentPage === 1 && (
          <div class="mb-20">
            <div class="text-section-label mb-4">Latest Article</div>
            <FeaturedPostCard post={featured} />
          </div>
        )
      }

      <!-- All Articles -->
      <div class="mb-20">
        <div class="text-section-label mb-4">All Articles</div>
        <div class="border-border space-y-0 border-t">
          {
            page.data.map((post, index) => (
              <PostCard post={post} index={index} />
            ))
          }
        </div>
      </div>

      <!-- Pagination -->
      <div class="px-2">
        <Pagination
          currentPage={page.currentPage}
          prevUrl={page.url.prev}
          nextUrl={page.url.next}
          first={page.url.first}
          last={page.url.last}
          totalPages={totalPages}
        />
      </div>
    </div>
  </section>
</BaseLayout>
