---
import { getCollection } from "astro:content";
import ProjectCard from "@/components/project/ProjectCard.astro";
import FeaturedCard from "@/components/project/FeaturedCard.astro";
import Button from "@/components/ui/Button.astro";
import { Icon } from "astro-icon/components";

// Load all non-draft projects
const projects = await getCollection("projects").then((entries) =>
  entries.filter((entry) => !entry.data.draft)
);

// Sort by most recent (modDatetime falls back to pubDatetime)
projects.sort((a, b) => {
  const aDate = new Date(a.data.modDatetime ?? a.data.pubDatetime).valueOf();
  const bDate = new Date(b.data.modDatetime ?? b.data.pubDatetime).valueOf();
  return bDate - aDate;
});

// Pick the latest featured project (fallback to most recent if none are featured)
const featured = projects.find((p) => p.data.featured) ?? projects[0];

// Left side: two latest non-featured (and not the featured one)
const rightProjects = projects.slice(0, 2);
// const rightProjects = projects.filter((p) => p.id !== featured?.id).slice(0, 2);
---

<div class="flex w-full flex-1 flex-col md:max-w-4xl lg:max-w-6xl">
  <!-- Header: title + View all button -->
  <div
    class="border-border flex flex-row items-center justify-between border-b px-6 pb-12"
  >
    <h1 class="text-text-default text-3xl" transition:name="latest-projects">
      Latest articles
    </h1>
    <a href="/project/" aria-label="View all projects">
      <Button
        variant="ghost"
        class="text-cyan! before:bg-cyan/30 relative overflow-hidden text-base before:absolute before:inset-0 before:-z-10 before:origin-right before:scale-x-0 before:transition-transform before:duration-300 before:ease-in-out hover:bg-transparent! hover:before:origin-left hover:before:scale-x-100 lg:text-lg"
      >
        <div class="flex flex-row items-center gap-3">
          <span>View all</span>
          <Icon name="arrow-right-up" />
        </div>
      </Button>
    </a>
  </div>

  <div
    class="flex w-full flex-col-reverse gap-8 lg:grid lg:grid-cols-2 lg:items-stretch lg:px-6"
  >
    <!-- Right side (featured) -->
    <div class="flex w-full py-4 lg:pt-12" transition:name="left-project">
      {featured && <FeaturedCard project={featured} class="h-full w-full" />}
    </div>

    <!-- Left side (scrolls) -->
    <div class="flex w-full flex-col lg:pt-12">
      <!-- Project (limit to 2) -->
      <div class="flex flex-col gap-8 py-4">
        {rightProjects.map((project) => <ProjectCard project={project} />)}
      </div>
    </div>
  </div>
</div>
