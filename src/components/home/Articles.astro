---
import { getCollection } from "astro:content";
import PostCard from "@/components/post/PostCard.astro";
import FeaturedCard from "@/components/post/FeaturedCard.astro";
import Button from "@/components/ui/Button.astro";
import { Icon } from "astro-icon/components";

// Load all non-draft posts
const posts = await getCollection("posts").then((entries) =>
  entries.filter((entry) => !entry.data.draft)
);

// Sort by most recent (modDatetime falls back to pubDatetime)
posts.sort((a, b) => {
  const aDate = new Date(a.data.modDatetime ?? a.data.pubDatetime).valueOf();
  const bDate = new Date(b.data.modDatetime ?? b.data.pubDatetime).valueOf();
  return bDate - aDate;
});

// Pick the latest featured post (fallback to most recent if none are featured)
const featured = posts.find((p) => p.data.featured) ?? posts[0];

// Left side: two latest non-featured (and not the featured one)
const leftPosts = posts.filter((p) => p.id !== featured?.id).slice(0, 2);
---

<div class="flex w-full flex-1 flex-col md:max-w-4xl lg:max-w-6xl">
  <!-- Header: title + View all button -->
  <div
    class="border-border flex flex-row items-center justify-between border-b px-6 pb-12"
  >
    <h1 class="text-text-default text-3xl" transition:name="latest-articles">
      Latest articles
    </h1>
    <a href="/post/" aria-label="View all posts">
      <Button
        variant="ghost"
        class="text-cyan! before:bg-cyan/30 relative overflow-hidden text-base before:absolute before:inset-0 before:-z-10 before:origin-right before:scale-x-0 before:transition-transform before:duration-300 before:ease-in-out hover:bg-transparent! hover:before:origin-left hover:before:scale-x-100 lg:text-lg"
      >
        <div class="flex flex-row items-center gap-3">
          <span>View all</span>
          <Icon name="arrow-right-up" />
        </div>
      </Button>
    </a>
  </div>

  <div
    class="flex w-full flex-col-reverse gap-8 px-6 lg:grid lg:grid-cols-2 lg:items-stretch"
  >
    <!-- Left side (scrolls) -->
    <div class="flex w-full flex-col lg:pt-12">
      <!-- Posts (limit to 2) -->
      <div class="flex flex-col gap-8 py-4">
        {leftPosts.map((post) => <PostCard post={post} />)}
      </div>
    </div>

    <!-- Right side (featured) -->
    <div class="flex w-full py-4 lg:pt-12" transition:name="right-post">
      {featured && <FeaturedCard post={featured} class="h-full w-full" />}
    </div>
  </div>
</div>
