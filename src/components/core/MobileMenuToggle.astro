---
import { Icon } from "astro-icon/components";
---

<!-- Toggle button -->
<div class="md:hidden">
  <button
    data-mobile-menu-toggle
    class="text-foreground-0 p-2"
    aria-label="Toggle menu"
    aria-expanded="false"
  >
    <span aria-hidden="true" data-icon-open>
      <Icon name="menu" class="h-6 w-6" />
    </span>
    <span aria-hidden="true" data-icon-close class="hidden">
      <Icon name="close" class="h-6 w-6" />
    </span>
  </button>
</div>

<script>
  document.addEventListener("astro:page-load", () => {
    const toggleBtn = document.querySelector("[data-mobile-menu-toggle]");
    const menu = document.querySelector("[data-mobile-menu]");
    if (!toggleBtn || !menu) return;

    const iconOpen = toggleBtn.querySelector("[data-icon-open]");
    const iconClose = toggleBtn.querySelector("[data-icon-close]");
    const panelCloseBtn = menu.querySelector("[data-mobile-menu-close]");

    // position panel under header
    const header = document.querySelector("header");
    const applyPanelPosition = () => {
      const headerHeight = header ? header.getBoundingClientRect().height : 0;
      (menu as HTMLElement).style.top = `${headerHeight}px`;
      (menu as HTMLElement).style.bottom = "0";
    };

    applyPanelPosition();
    window.addEventListener("resize", applyPanelPosition);

    const onKey = (e: KeyboardEvent) => {
      if (e.key === "Escape") setOpen(false);
    };

    function setOpen(open: boolean) {
      (menu as HTMLElement).setAttribute("data-open", String(open));
      (menu as HTMLElement).setAttribute("aria-hidden", String(!open));
      (toggleBtn as HTMLElement).setAttribute("aria-expanded", String(open));
      iconOpen && iconOpen.classList.toggle("hidden", open);
      iconClose && iconClose.classList.toggle("hidden", !open);

      if (open) {
        document.addEventListener("keydown", onKey);
        (panelCloseBtn as HTMLElement | null)?.focus();
        document.dispatchEvent(new CustomEvent("mobile-menu:opened"));
      } else {
        document.removeEventListener("keydown", onKey);
        (toggleBtn as HTMLElement).focus();
        document.dispatchEvent(new CustomEvent("mobile-menu:closed"));
      }
    }

    toggleBtn.addEventListener("click", () =>
      setOpen(menu.getAttribute("data-open") !== "true"),
    );
    panelCloseBtn &&
      panelCloseBtn.addEventListener("click", () => setOpen(false));

    menu.addEventListener("click", (e) => {
      const target = e.target;
      if (!(target instanceof Element)) return;
      if (target === menu) return setOpen(false);
      const isCloseButton = !!target.closest("[data-mobile-menu-close]");
      if (!isCloseButton && (target.closest("a") || target.closest("button")))
        setOpen(false);
    });
  });
</script>
