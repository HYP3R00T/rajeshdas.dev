---
import Button from "@/components/ui/Button.astro";
import { Icon } from "astro-icon/components";
---

<!-- Toggle button (single button containing both icons) -->
<div class="md:hidden">
  <Button
    size="icon"
    data-mobile-menu-toggle
    aria-label="Toggle menu"
    aria-expanded="false"
  >
    <span aria-hidden="true" data-icon-open>
      <Icon name="menu" />
    </span>
    <span aria-hidden="true" data-icon-close class="hidden">
      <Icon name="close" />
    </span>
  </Button>
</div>

<script>
  document.addEventListener("astro:page-load", () => {
    const toggleBtn = document.querySelector("[data-mobile-menu-toggle]");
    const menu =
      document.querySelector("[data-mobile-menu]") ||
      document.getElementById("mobile-menu");

    if (!toggleBtn || !menu) return;

    const iconOpen = toggleBtn.querySelector("[data-icon-open]");
    const iconClose = toggleBtn.querySelector("[data-icon-close]");

    const onKeyDown = (e: KeyboardEvent) => {
      if (e.key === "Escape") hideMenu();
    };

    function showMenu() {
      menu!.classList.remove("hidden");
      toggleBtn!.setAttribute("aria-expanded", "true");
      iconOpen && iconOpen.classList.add("hidden");
      iconClose && iconClose.classList.remove("hidden");
      document.addEventListener("keydown", onKeyDown);
      document.dispatchEvent(new CustomEvent("mobile-menu:opened"));
    }

    function hideMenu() {
      menu!.classList.add("hidden");
      toggleBtn!.setAttribute("aria-expanded", "false");
      iconOpen && iconOpen.classList.remove("hidden");
      iconClose && iconClose.classList.add("hidden");
      document.removeEventListener("keydown", onKeyDown);
      document.dispatchEvent(new CustomEvent("mobile-menu:closed"));
    }

    toggleBtn.addEventListener("click", () => {
      if (menu!.classList.contains("hidden")) showMenu();
      else hideMenu();
    });

    // Close when a link/button inside the panel is clicked
    menu.addEventListener("click", (e) => {
      const target = e.target;
      if (!(target instanceof Element)) return;
      if (target.closest("a") || target.closest("button")) {
        hideMenu();
      }
    });
  });
</script>
