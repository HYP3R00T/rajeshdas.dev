---
import Button from "@/components/ui/Button.astro";
import { Icon } from "astro-icon/components";
---

<!-- Toggle buttons only (placed inside header row) -->
<div class="md:hidden">
  <Button
    size="icon"
    data-mobile-menu-open
    aria-label="Open menu"
    aria-expanded="false"
  >
    <Icon name="menu" />
  </Button>
  <Button
    size="icon"
    data-mobile-menu-close
    class="hidden"
    aria-label="Close menu"
    aria-hidden="true"
  >
    <Icon name="close" />
  </Button>
</div>

<script>
  document.addEventListener("astro:page-load", () => {
    const openBtn = document.querySelector("[data-mobile-menu-open]");
    const closeBtn = document.querySelector("[data-mobile-menu-close]");
    const menu =
      document.querySelector("[data-mobile-menu]") ||
      document.getElementById("mobile-menu");

    if (!openBtn || !closeBtn || !menu) return;

    const onKeyDown = (e: KeyboardEvent) => {
      if (e.key === "Escape") hideMenu();
    };

    function showMenu() {
      menu!.classList.remove("hidden");
      openBtn!.classList.add("hidden");
      openBtn!.setAttribute("aria-expanded", "true");
      closeBtn!.classList.remove("hidden");
      closeBtn!.removeAttribute("aria-hidden");
      document.addEventListener("keydown", onKeyDown);
      document.dispatchEvent(new CustomEvent("mobile-menu:opened"));
    }

    function hideMenu() {
      menu!.classList.add("hidden");
      openBtn!.classList.remove("hidden");
      openBtn!.setAttribute("aria-expanded", "false");
      closeBtn!.classList.add("hidden");
      closeBtn!.setAttribute("aria-hidden", "true");
      document.removeEventListener("keydown", onKeyDown);
      document.dispatchEvent(new CustomEvent("mobile-menu:closed"));
    }

    openBtn.addEventListener("click", showMenu);
    closeBtn.addEventListener("click", hideMenu);

    // Close when a link/button inside the panel is clicked
    menu.addEventListener("click", (e) => {
      const target = e.target;
      if (!(target instanceof Element)) return;
      if (target.closest("a") || target.closest("button")) {
        hideMenu();
      }
    });
  });
</script>
