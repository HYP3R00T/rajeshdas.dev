---
import { getCollection, type CollectionEntry } from "astro:content";
import Badge from "@/components/ui/Badge.astro";
import ProjectCard from "@/components/project/ProjectCard.astro";
import Button from "@/components/ui/Button.astro";

// Get all projects, filter drafts, then sort by order and dates
const allProjects = await getCollection("projects");
const projects = allProjects.filter((p) => !p.data.draft);

type ProjectEntry = CollectionEntry<"projects">;

const shouldSortProjects = projects.some(
  (p) => p.data.order !== undefined || p.data.startDate || p.data.endDate,
);

const sortByOrderAndDate = (a: ProjectEntry, b: ProjectEntry) => {
  const orderDiff = (a.data.order ?? 999) - (b.data.order ?? 999);
  if (orderDiff !== 0) {
    return orderDiff;
  }

  const aDate = (a.data.endDate ?? a.data.startDate)?.getTime() ?? 0;
  const bDate = (b.data.endDate ?? b.data.startDate)?.getTime() ?? 0;
  const dateDiff = bDate - aDate;
  return dateDiff !== 0 ? dateDiff : 0;
};

const sortedProjects = shouldSortProjects
  ? [...projects].sort(sortByOrderAndDate)
  : projects;
---

<section
  class="stripe-pattern relative flex items-center justify-center px-6 py-32 md:px-12"
>
  <div class="mx-auto w-full max-w-7xl">
    <!-- Badge -->
    <Badge variant="outline">Selected Work</Badge>
    <h1 class="text-section-heading my-8">
      <div>PROJECTS</div>
    </h1>

    <p
      class="text-foreground-1 max-w-2xl space-y-6 text-base leading-relaxed md:text-lg"
    >
      Recent projects and tools I've built to solve real-world DevOps challenges
    </p>

    <div class="mt-8 grid md:grid-cols-2">
      {
        sortedProjects.map((project, index) => (
          <ProjectCard project={project} index={index} />
        ))
      }
    </div>

    <div class="mt-12 text-center">
      <a href="/project/">
        <Button size="lg" class="uppercase">View All Projects</Button>
      </a>
    </div>
  </div>
</section>
